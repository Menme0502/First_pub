<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>マインスイーパー</title>
<style>
  body {
    background: #1e1e1e;
    color: #fff;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
  }
  h1 { margin: 10px 0; }
  .controls { margin-bottom: 10px; }
  .board {
    display: grid;
    gap: 2px;
    background: #444;
    padding: 10px;
    border-radius: 8px;
  }
  .cell {
    width: 30px;
    height: 30px;
    background-color: #ccc;
    border: 1px solid #999;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 16px;
    cursor: pointer;
    user-select: none;
    color: black;
    transition: transform 0.15s ease, background-color 0.2s ease, box-shadow .25s ease;
  }
  .cell:active { animation: popShake 0.4s ease; }
  .opened { background-color: #eee !important; color: black !important; cursor: default; }
  .bomb { background-color: #ff4d4d !important; color: white; }
  .flag { background-color: #ffd700 !important; color: black; }

  /* 開いた瞬間のパルス輪郭 */
  .pulse { animation: pulseOpen .35s ease; }
  @keyframes pulseOpen {
    0%   { box-shadow: 0 0 0 0 rgba(255,255,255,.25); }
    100% { box-shadow: 0 0 0 16px rgba(255,255,255,0); }
  }

  @keyframes popShake {
    0% { transform: scale(1) rotate(0deg); }
    20% { transform: scale(1.15) rotate(-3deg); }
    40% { transform: scale(0.95) rotate(3deg); }
    60% { transform: scale(1.08) rotate(-2deg); }
    80% { transform: scale(0.98) rotate(1deg); }
    100% { transform: scale(1) rotate(0deg); }
  }

  /* 数字色 */
  .n1{color:#1976d2}.n2{color:#2e7d32}.n3{color:#d32f2f}.n4{color:#7b1fa2}
  .n5{color:#ff6f00}.n6{color:#00838f}.n7{color:#5d4037}.n8{color:#263238}

  /* フラッシュ＆揺れ */
  .flash, .flash-gold {
    position: fixed; inset: 0; z-index: 999; pointer-events: none;
    animation: flashAnim .4s ease;
  }
  .flash { background: rgba(255,0,0,.65); }
  .flash-gold { background: rgba(255,215,0,.65); animation-duration:.6s; }
  @keyframes flashAnim { from{opacity:.9} to{opacity:0} }

  .shake { animation: screenShake .45s cubic-bezier(.36,.07,.19,.97); }
  @keyframes screenShake{
    10%,90%{ transform: translateX(-2px) }
    20%,80%{ transform: translateX(3px) }
    30%,50%,70%{ transform: translateX(-5px) }
    40%,60%{ transform: translateX(5px) }
    100%{ transform: translateX(0) }
  }

  /* 紙吹雪 */
  .confetti{
    position: fixed; top: -12px; width:8px; height:14px; opacity:.95;
    z-index: 1000; border-radius:2px;
    animation: confettiFall 1.4s ease-in forwards;
  }
  @keyframes confettiFall{
    to { transform: translate(var(--dx,0px), 110vh) rotate(720deg); opacity:1; }
  }

  @keyframes bombBounce {
    0% { transform: scale(1) rotate(0deg); }
    25% { transform: scale(1.3) rotate(10deg); }
    50% { transform: scale(0.8) rotate(-10deg); }
    75% { transform: scale(1.1) rotate(5deg); }
    100% { transform: scale(1) rotate(0deg); }
  }
</style>
</head>
<body>
<h1>マインスイーパー</h1>
<div class="controls">
  サイズ: <input type="number" id="sizeInput" value="10" min="5" max="30">
  爆弾数: <input type="number" id="bombInput" value="15" min="1">
  <button id="startBtn">開始</button>
  <span id="recommend"></span>
</div>
<div id="board" class="board"></div>

<script>
let size = 10;
let bombCount = 15;
let board = [];
let gameOver = false;
let bombsPlaced = false;   // ← 初手まで地雷配置しない
let openCooldown = 0;      // クリック音の多重抑制

// AudioContext（1つに統一）＋初回解禁
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let audioUnlocked = false;
function unlockAudio(){ if(!audioUnlocked){ audioCtx.resume().then(()=>audioUnlocked=true).catch(()=>{}); } }

// ---- エフェクト util ----
function flashScreen() { const d=document.createElement('div'); d.className='flash'; document.body.appendChild(d); setTimeout(()=>d.remove(),400); }
function flashGold()   { const d=document.createElement('div'); d.className='flash-gold'; document.body.appendChild(d); setTimeout(()=>d.remove(),600); }
function shakeScreen() { document.body.classList.add('shake'); setTimeout(()=>document.body.classList.remove('shake'),460); }
function confettiBurst(n=42){
  for(let i=0;i<n;i++){
    const s=document.createElement('div'); s.className='confetti';
    s.style.left = (Math.random()*100)+'vw';
    s.style.background = `hsl(${Math.random()*360},90%,60%)`;
    s.style.setProperty('--dx', (Math.random()*240-120)+'px');
    s.style.animationDuration = (1.0 + Math.random()*0.8)+'s';
    document.body.appendChild(s);
    setTimeout(()=>s.remove(), 2200);
  }
}

// ---- サウンド ----
function playClickSound(){
  const now = audioCtx.currentTime;
  if (now - openCooldown < 0.04) return; // 40ms以内はミュート
  openCooldown = now;
  const osc = audioCtx.createOscillator();
  const g   = audioCtx.createGain();
  osc.type='sine';
  osc.frequency.setValueAtTime(880, now);
  g.gain.setValueAtTime(0.16, now);
  g.gain.exponentialRampToValueAtTime(0.01, now + 0.06);
  osc.connect(g).connect(audioCtx.destination);
  osc.start(now); osc.stop(now + 0.06);
}
function playExplosionSound(){
  const now = audioCtx.currentTime;
  const o = audioCtx.createOscillator(), g = audioCtx.createGain();
  o.type='square';
  o.frequency.setValueAtTime(90, now);
  o.frequency.exponentialRampToValueAtTime(35, now + 0.22);
  g.gain.setValueAtTime(0.5, now);
  g.gain.exponentialRampToValueAtTime(0.01, now + 0.22);
  o.connect(g).connect(audioCtx.destination);
  o.start(now); o.stop(now + 0.24);
}
function playFanfare(){
  const now = audioCtx.currentTime;
  [523,659,784].forEach((f,i)=>{
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='triangle'; o.frequency.setValueAtTime(f, now + i*0.1);
    g.gain.setValueAtTime(0.28, now + i*0.1);
    g.gain.exponentialRampToValueAtTime(0.01, now + 0.28 + i*0.1);
    o.connect(g).connect(audioCtx.destination);
    o.start(now + i*0.1); o.stop(now + 0.28 + i*0.1);
  });
}

// ---- セットアップ ----
const boardEl = document.getElementById('board');
const sizeInput = document.getElementById('sizeInput');
const bombInput = document.getElementById('bombInput');
const recommendEl = document.getElementById('recommend');
document.getElementById('startBtn').addEventListener('click', startGame);
sizeInput.addEventListener('input', updateRecommend);
bombInput.addEventListener('input', updateRecommend);

function updateRecommend(){
  const s = Math.max(5, Math.min(30, parseInt(sizeInput.value)||10));
  recommendEl.textContent = `(推奨: ${Math.max(1, Math.round(s*s*0.15))}個)`;
}

function startGame() {
  size = Math.max(5, Math.min(30, parseInt(sizeInput.value)||10));
  bombCount = Math.max(1, parseInt(bombInput.value)||15);
  sizeInput.value = size; bombInput.value = bombCount;
  updateRecommend();

  board = [];
  gameOver = false;
  bombsPlaced = false;
  boardEl.innerHTML = '';
  boardEl.style.gridTemplateColumns = `repeat(${size}, 30px)`;

  for (let y = 0; y < size; y++) {
    board[y] = [];
    for (let x = 0; x < size; x++) {
      const el = document.createElement('div');
      el.className = 'cell';
      el.addEventListener('pointerdown', unlockAudio, {once:true}); // 初回でオーディオ解禁
      el.addEventListener('click', () => handleCellClick(x, y));
      el.addEventListener('contextmenu', (e) => { e.preventDefault(); toggleFlag(x, y); });
      boardEl.appendChild(el);
      board[y][x] = { bomb: false, opened: false, flagged: false, count: 0, el };
    }
  }
}

// === 初手セーフ：クリック地点＋周囲8マスを安全にして配置 ===
function placeBombsSafe(sx, sy) {
  const safe = new Set();
  for (let dy=-1; dy<=1; dy++){
    for (let dx=-1; dx<=1; dx++){
      const nx = sx+dx, ny = sy+dy;
      if (nx>=0 && nx<size && ny>=0 && ny<size) safe.add(ny*size + nx);
    }
  }
  const candidates = [];
  for (let y=0; y<size; y++){
    for (let x=0; x<size; x++){
      const id = y*size + x;
      if (!safe.has(id)) candidates.push([x,y]);
    }
  }
  // 候補より爆弾数が多い場合は上限に丸める
  const toPlace = Math.min(bombCount, candidates.length);

  // シャッフルして先頭 toPlace を爆弾に
  for (let i=candidates.length-1; i>0; i--){
    const j = (Math.random()*(i+1))|0;
    [candidates[i], candidates[j]] = [candidates[j], candidates[i]];
  }
  for (let i=0; i<toPlace; i++){
    const [x,y] = candidates[i];
    board[y][x].bomb = true;
  }

  // 数字計算
  for (let y=0; y<size; y++){
    for (let x=0; x<size; x++){
      if (board[y][x].bomb){ board[y][x].count = 0; continue; }
      let c = 0;
      for (let dy=-1; dy<=1; dy++){
        for (let dx=-1; dx<=1; dx++){
          if (dx===0 && dy===0) continue;
          const nx=x+dx, ny=y+dy;
          if (nx>=0 && nx<size && ny>=0 && ny<size && board[ny][nx].bomb) c++;
        }
      }
      board[y][x].count = c;
    }
  }
  bombsPlaced = true;
}

function handleCellClick(x, y) {
  if (gameOver) return;
  const cell = board[y][x];
  if (cell.opened || cell.flagged) return;

  // 初手で安全配置
  if (!bombsPlaced) {
    placeBombsSafe(x, y);
  }

  openCell(x, y);
  if (!gameOver) playClickSound();

  if (checkWin()) {
    gameOverSequence(true);
  }
}

function openCell(x, y) {
  const cell = board[y][x];
  if (cell.opened || cell.flagged) return;

  cell.opened = true;
  cell.el.classList.add('opened','pulse');
  setTimeout(()=>cell.el.classList.remove('pulse'), 380);

  if (cell.bomb) {
    cell.el.classList.add('bomb');
    triggerExplosion();
    gameOverSequence(false);
    return;
  }
  if (cell.count > 0) {
    cell.el.textContent = cell.count;
    if (cell.count>=1 && cell.count<=8) cell.el.classList.add('n'+cell.count);
  } else {
    // 連鎖オープン
    for (let dy=-1; dy<=1; dy++){
      for (let dx=-1; dx<=1; dx++){
        if (dx===0 && dy===0) continue;
        const nx = x+dx, ny = y+dy;
        if (nx>=0 && nx<size && ny>=0 && ny<size) openCell(nx, ny);
      }
    }
  }
}

function toggleFlag(x, y) {
  if (gameOver) return;
  const cell = board[y][x];
  if (cell.opened) return;
  cell.flagged = !cell.flagged;
  cell.el.textContent = cell.flagged ? '🚩' : '';
  cell.el.classList.toggle('flag', cell.flagged);
}

function checkWin() {
  for (let y=0; y<size; y++){
    for (let x=0; x<size; x++){
      const c = board[y][x];
      if (!c.bomb && !c.opened) return false;
    }
  }
  return true;
}

function gameOverSequence(win) {
  gameOver = true;
  // 全爆弾表示 & 操作停止
  for (let y=0; y<size; y++){
    for (let x=0; x<size; x++){
      const c = board[y][x];
      if (c.bomb) {
        c.el.textContent = '💣';
        c.el.classList.add('bomb');
        c.el.style.animation = 'bombBounce .5s ease';
      }
      c.el.style.pointerEvents = 'none';
    }
  }
  if (win) {
    playFanfare(); flashGold(); shakeScreen(); confettiBurst(42);
    setTimeout(()=>alert('クリア！'), 220);
  } else {
    setTimeout(()=>alert('ゲームオーバー！'), 220);
  }
}

function triggerExplosion() {
  playExplosionSound();
  flashScreen();
  shakeScreen();
}

// 起動
updateRecommend();
startGame();
</script>
</body>
</html>
