<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç¿’æ…£ãƒˆãƒ©ãƒƒã‚«ãƒ¼ Ã— Heatmap</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg: #0b0c10;
    --panel: #111218;
    --text: #e7e7ea;
    --muted:#a9adbd;
    --accent: 252 70% 65%;
    --ok: 160 60% 50%;
    --warn: 30 95% 56%;
    --bad: 0 80% 60%;
    --ring: 220 90% 60%;
    --cell-bg: #161823;
    --cell-bd: #1f2333;
    --kbd-bg: #1f2333;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg: #f6f7fb;
      --panel:#ffffff;
      --text:#16181f;
      --muted:#606776;
      --cell-bg:#eef1f7;
      --cell-bd:#dde3ef;
      --kbd-bg:#eef1f7;
      --shadow: 0 8px 24px rgba(20,23,28,.08);
    }
  }
  [data-theme="light"]{
    --bg: #f6f7fb;
    --panel:#ffffff;
    --text:#16181f;
    --muted:#606776;
    --cell-bg:#eef1f7;
    --cell-bd:#dde3ef;
    --kbd-bg:#eef1f7;
    --shadow: 0 8px 24px rgba(20,23,28,.08);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font: 14px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Apple Color Emoji","Segoe UI Emoji";
    color: var(--text);
    background: radial-gradient(1200px 800px at 10% -10%, rgba(88,101,242,.12), transparent 50%), var(--bg);
  }
  .app{
    display:grid;
    grid-template-columns: 320px 1fr;
    gap: 20px; padding: 20px; max-width: 1200px; margin: 0 auto;
  }
  header{
    grid-column: 1 / -1; display:flex; align-items:center; justify-content:space-between; gap:16px;
  }
  .title{
    display:flex; align-items:center; gap:12px;
    padding:10px 14px; background: var(--panel);
    border-radius:12px; box-shadow: var(--shadow);
  }
  .title h1{font-size:18px; margin:0}
  .badge{
    font-weight:700; letter-spacing:.05em; color:hsl(var(--accent)); background: hsl(var(--accent) / .12);
    border:1px solid hsl(var(--accent) / .35); padding:4px 8px; border-radius:999px;
  }
  .controls{display:flex; gap:10px; align-items:center}
  button, .btn{
    appearance:none; border:1px solid hsl(var(--ring) / .35); background: var(--panel); color:var(--text);
    padding:10px 12px; border-radius:10px; cursor:pointer; transition: .2s ease; box-shadow: var(--shadow);
  }
  button:hover{transform: translateY(-1px)}
  button:active{transform: translateY(0)}
  .ghost{background:transparent; border-color: transparent; box-shadow:none; padding:8px 10px}
  .toggle{display:inline-flex; align-items:center; gap:8px}
  .kbd{font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace; background:var(--kbd-bg); border:1px solid var(--cell-bd);
       padding:2px 6px; border-radius:6px; font-size:12px}
  main{display:contents}
  .sidebar{
    background: var(--panel); border:1px solid hsl(var(--ring) / .15); border-radius:16px; padding:16px; box-shadow: var(--shadow);
    display:flex; flex-direction:column; gap:14px; min-height: 520px;
  }
  .habits{display:flex; flex-direction:column; gap:8px; max-height: 280px; overflow:auto; padding-right:4px}
  .habit{
    display:flex; align-items:center; gap:10px; padding:10px; border:1px solid var(--cell-bd); background:var(--cell-bg);
    border-radius:12px; cursor:pointer; transition:.15s ease; outline: none;
  }
  .habit[aria-current="true"]{border-color:hsl(var(--ring)); box-shadow: 0 0 0 2px hsl(var(--ring) / .35) inset}
  .habit .left{display:flex; align-items:center; gap:10px}
  .swatch{width:14px; height:14px; border-radius:4px; border:1px solid var(--cell-bd)}
  .habit .name{font-weight:600}
  .empty{color:var(--muted); text-align:center; padding:16px}
  .add{
    display:grid; grid-template-columns: 3.5em 1fr 6em; gap:8px; align-items:center; margin-top:6px;
  }
  input[type="text"], input[type="search"], select, textarea{
    width:100%; background: var(--cell-bg); color:var(--text); border:1px solid var(--cell-bd); border-radius:10px; padding:10px 12px;
    outline:none; transition: border-color .15s ease;
  }
  input:focus, select:focus, textarea:focus{border-color:hsl(var(--ring))}
  .danger{color:hsl(var(--bad))}
  .muted{color:var(--muted)}
  .grid-panel{
    background: var(--panel); border:1px solid hsl(var(--ring) / .15); border-radius:16px; padding:16px; box-shadow: var(--shadow);
  }
  .grid-header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px}
  .grid-header .meta{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .grid{
    display:grid; grid-auto-flow: column; grid-auto-columns: 14px; grid-template-rows: repeat(7, 14px);
    gap:4px; padding:12px; border-radius:12px; overflow:auto; background: linear-gradient(0deg, transparent, transparent 11px, var(--cell-bd) 11px, var(--cell-bd) 12px, transparent 12px);
    background-size: 100% 18px;
    outline:none; border:1px dashed transparent;
  }
  .grid:focus{border-color:hsl(var(--ring))}
  .cell{
    width:14px; height:14px; border-radius:3px; border:1px solid var(--cell-bd); background: var(--cell-bg); position:relative;
  }
  .cell[aria-pressed="true"]{border-color: transparent}
  .legend{display:flex; align-items:center; gap:6px; font-size:12px; color:var(--muted)}
  .legend .box{width:14px; height:14px; border-radius:3px; border:1px solid var(--cell-bd)}
  .stats{
    display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; margin-top:10px;
  }
  .stat{
    background: var(--cell-bg); border:1px solid var(--cell-bd); border-radius:12px; padding:12px; text-align:center;
  }
  .stat h3{margin:0; font-size:12px; color:var(--muted)}
  .stat div{font-weight:800; font-size:20px}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .sr-only{position:absolute; width:1px; height:1px; margin:-1px; clip:rect(0 0 0 0); overflow:hidden; white-space:nowrap; border:0; padding:0}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .hidden{display:none !important}
  @media (max-width: 960px){
    .app{grid-template-columns: 1fr}
  }
</style>
</head>
<body>
<div class="app" id="app" data-theme="">
  <header>
    <div class="title">
      <span class="badge">DEMO</span>
      <h1>ç¿’æ…£ãƒˆãƒ©ãƒƒã‚«ãƒ¼ Ã— Heatmap</h1>
    </div>
    <div class="controls">
      <button id="themeBtn" class="toggle" aria-pressed="false" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿ (L)">
        <span>ğŸŒ“</span><span>ãƒ†ãƒ¼ãƒ</span><span class="kbd">L</span>
      </button>
      <button id="exportBtn" title="JSONã«æ›¸ãå‡ºã—">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <label class="btn" for="importFile" title="JSONã‚’èª­ã¿è¾¼ã¿">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</label>
      <input id="importFile" type="file" accept="application/json" class="hidden" />
    </div>
  </header>

  <aside class="sidebar" aria-label="ç¿’æ…£ãƒªã‚¹ãƒˆ">
    <div class="row" style="justify-content:space-between">
      <strong>ç¿’æ…£</strong>
      <button id="clearAll" class="ghost danger" title="ã™ã¹ã¦å‰Šé™¤">ğŸ—‘ ã‚¯ãƒªã‚¢</button>
    </div>
    <div id="habitList" class="habits" role="listbox" aria-label="ç¿’æ…£ã‚’é¸æŠ"></div>
    <div class="empty muted" id="emptyMsg">ã¾ã ç¿’æ…£ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>

    <form id="addForm" class="add" autocomplete="off">
      <input id="emoji" type="text" inputmode="text" maxlength="2" placeholder="ğŸ˜Š" aria-label="çµµæ–‡å­—" />
      <input id="name" type="text" placeholder="ç¿’æ…£åï¼ˆä¾‹ï¼šè‹±èª30åˆ†ï¼‰" aria-label="ç¿’æ…£å" required />
      <select id="hue" aria-label="è‰²ç›¸">
        <option value="200">ãƒ–ãƒ«ãƒ¼</option>
        <option value="140">ã‚°ãƒªãƒ¼ãƒ³</option>
        <option value="30">ã‚ªãƒ¬ãƒ³ã‚¸</option>
        <option value="0">ãƒ¬ãƒƒãƒ‰</option>
        <option value="280">ãƒ‘ãƒ¼ãƒ—ãƒ«</option>
        <option value="320">ãƒ”ãƒ³ã‚¯</option>
      </select>
      <button type="submit">ï¼‹ è¿½åŠ </button>
    </form>
  </aside>

  <section class="grid-panel">
    <div class="grid-header">
      <div class="meta">
        <div class="row">
          <strong id="currentHabitLabel">ç¿’æ…£ã‚’é¸æŠã—ã¦ãã ã•ã„</strong>
        </div>
        <div class="legend" id="legend">
          <span>å°‘</span>
          <span class="box" style="background:#fff0; border-color:var(--cell-bd)"></span>
          <span class="box" id="lg1"></span>
          <span class="box" id="lg2"></span>
          <span class="box" id="lg3"></span>
          <span class="box" id="lg4"></span>
          <span>å¤š</span>
        </div>
      </div>
      <div class="row">
        <span class="muted">ãƒ‰ãƒ©ãƒƒã‚°ã§å¡—ã‚Šã¤ã¶ã— / <span class="kbd">â†â†‘â†’â†“</span> + <span class="kbd">Enter</span></span>
        <button id="todayBtn" title="ä»Šæ—¥ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«">ğŸ“… ä»Šæ—¥</button>
    </div>
    </div>

    <div id="grid" class="grid" role="grid" aria-label="æ—¥ä»˜ã®ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—" tabindex="0"></div>

    <div class="stats">
      <div class="stat">
        <h3>ç¾åœ¨ã®é€£ç¶š</h3>
        <div id="streakNow">-</div>
      </div>
      <div class="stat">
        <h3>æœ€é•·é€£ç¶š</h3>
        <div id="streakMax">-</div>
      </div>
      <div class="stat">
        <h3>é”æˆç‡</h3>
        <div id="rate">-</div>
      </div>
    </div>
  </section>
</div>

<script>
(() => {
  // --- Utilities ------------------------------------------------------------
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];
  const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
  const fmtDate = d => d.toISOString().slice(0,10);
  const parseDate = s => new Date(s+'T00:00:00');
  const todayStr = ()=>fmtDate(new Date());
  const storageKey = "habit-heatmap:v1";

  const state = {
    habits: [],
    selectedId: null,
    drag: { active:false, mode:true }, // true=fill, false=erase
    year: new Date().getFullYear(),
    theme: (()=> localStorage.getItem("theme") || "")()
  };

  // --- Persistence ----------------------------------------------------------
  const save = () => {
    localStorage.setItem(storageKey, JSON.stringify({habits: state.habits, selectedId: state.selectedId}));
    if(state.theme) localStorage.setItem("theme", state.theme);
  };
  const load = () => {
    try{
      const raw = localStorage.getItem(storageKey);
      if(raw){
        const parsed = JSON.parse(raw);
        state.habits = parsed.habits || [];
        state.selectedId = parsed.selectedId ?? null;
      }
      const t = localStorage.getItem("theme");
      if(t) state.theme = t;
    }catch(e){ console.warn(e) }
  };

  // --- Model helpers --------------------------------------------------------
  const newHabit = (name, emoji, hue) => ({
    id: "h" + crypto.randomUUID(),
    name, emoji: emoji || "âœ…", hue: Number(hue)||200,
    entries: {} // yyyy-mm-dd : true
  });

  const getHabit = id => state.habits.find(h=>h.id===id) || null;
  const selected = () => getHabit(state.selectedId);

  // --- Rendering: Habits ----------------------------------------------------
  function renderHabits(){
    const list = $("#habitList");
    list.innerHTML = "";
    if(state.habits.length===0){
      $("#emptyMsg").classList.remove("hidden");
      $("#currentHabitLabel").textContent = "ç¿’æ…£ã‚’é¸æŠã—ã¦ãã ã•ã„";
    }else{
      $("#emptyMsg").classList.add("hidden");
    }
    state.habits.forEach(h=>{
      const li = document.createElement("button");
      li.type = "button";
      li.role = "option";
      li.className = "habit";
      li.setAttribute("aria-current", h.id===state.selectedId ? "true" : "false");
      li.innerHTML = `
        <div class="left">
          <div class="swatch" style="background:hsl(${h.hue} 70% 55%)"></div>
          <div class="name">${escapeHtml(h.emoji || "âœ…")} ${escapeHtml(h.name)}</div>
        </div>
        <div style="margin-left:auto; display:flex; gap:6px">
          <span class="muted mono">${Object.keys(h.entries).length}</span>
          <button class="ghost danger" data-del="${h.id}" title="å‰Šé™¤">âœ–</button>
        </div>
      `;
      li.addEventListener("click", (ev)=>{
        if(ev.target.closest("[data-del]")) return; // delete button handled below
        state.selectedId = h.id; save();
        renderHabits(); renderHeatmap(); updateStats();
      });
      list.appendChild(li);
    });
    // delete handlers
    list.addEventListener("click", (ev)=>{
      const btn = ev.target.closest("[data-del]");
      if(!btn) return;
      const id = btn.getAttribute("data-del");
      const idx = state.habits.findIndex(h=>h.id===id);
      if(idx>=0 && confirm("ã“ã®ç¿’æ…£ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
        state.habits.splice(idx,1);
        if(state.selectedId===id) state.selectedId = state.habits[0]?.id ?? null;
        save(); renderHabits(); renderHeatmap(); updateStats();
      }
    }, { once: true });
  }

  // --- Rendering: Heatmap ---------------------------------------------------
  function yearDays(year){
    const start = new Date(Date.UTC(year,0,1));
    const end = new Date(Date.UTC(year,11,31));
    const days=[];
    for(let d=new Date(start); d<=end; d.setUTCDate(d.getUTCDate()+1)){
      days.push(new Date(d));
    }
    return days;
  }

  function colorScale(hue){
    // 5 levels (0..4)
    return [
      `color-mix(in oklab, hsl(${hue} 70% 60%) 0%, transparent)`,
      `color-mix(in oklab, hsl(${hue} 70% 60%) 25%, transparent)`,
      `color-mix(in oklab, hsl(${hue} 70% 60%) 50%, transparent)`,
      `color-mix(in oklab, hsl(${hue} 70% 60%) 75%, transparent)`,
      `hsl(${hue} 70% 50%)`
    ];
  }

  function monthLabels(columns){
    // return array [{colIndex, label}]
    const map=[];
    let prevMonth=-1;
    columns.forEach((col, i)=>{
      const m = col.date.getUTCMonth();
      if(m!==prevMonth){
        map.push({ i, label: `${m+1}æœˆ` });
        prevMonth = m;
      }
    });
    return map;
  }

  function buildColumns(days){
    // Convert to weeks columns (Sun..Sat rows), like GitHub style
    const cols=[];
    let col=[];
    // Ensure first column starts on Sunday
    const first = days[0];
    let offset = first.getUTCDay(); // 0 Sun..6 Sat
    for(let i=0;i<offset;i++){ col.push(null) } // pad before first day
    days.forEach(d=>{
      const day = d.getUTCDay();
      col[day] = d;
      if(day===6){ // Saturday -> push column, start new
        cols.push({ date: d, days: [...col]});
        col=[];
      }
    });
    if(col.length){
      cols.push({ date: days[days.length-1], days:[...col]});
    }
    return cols;
  }

  function renderHeatmap(){
    const grid = $("#grid");
    grid.innerHTML = "";
    const h = selected();
    const label = $("#currentHabitLabel");
    if(!h){
      label.textContent = "ç¿’æ…£ã‚’é¸æŠã—ã¦ãã ã•ã„";
      return;
    }
    label.textContent = `${h.emoji || "âœ…"} ${h.name}ï¼ˆ${state.year}å¹´ï¼‰`;
    const days = yearDays(state.year);
    const columns = buildColumns(days);
    const palette = colorScale(h.hue);

    // set legend
    $("#lg1").style.background = palette[1];
    $("#lg2").style.background = palette[2];
    $("#lg3").style.background = palette[3];
    $("#lg4").style.background = palette[4];

    // Create cells
    columns.forEach((col, ci)=>{
      // For keyboard navigation, column wrapper
      const colFrag = document.createDocumentFragment();
      for(let ri=0; ri<7; ri++){
        const dd = col.days[ri] || null;
        const btn = document.createElement("button");
        btn.type="button";
        btn.className="cell";
        btn.role = "gridcell";
        btn.tabIndex = -1;
        if(dd){
          const key = fmtDate(new Date(dd));
          const done = !!h.entries[key];
          btn.dataset.date = key;
          styleCell(btn, done, palette);
          btn.setAttribute("aria-label", `${key} ${done? "é”æˆæ¸ˆã¿" : "æœªé”"}`);
          btn.setAttribute("aria-pressed", String(done));
          btn.title = key;
          btn.addEventListener("mousedown", (e)=>{
            e.preventDefault();
            const now = !!h.entries[key];
            state.drag.active = true;
            state.drag.mode = !now; // fill if currently empty, else erase
            setDone(h, key, state.drag.mode);
            styleCell(btn, state.drag.mode, palette, true);
            updateStatsThrottled();
          });
          btn.addEventListener("mouseenter", ()=>{
            if(!state.drag.active) return;
            setDone(h, key, state.drag.mode);
            styleCell(btn, state.drag.mode, palette, true);
            updateStatsThrottled();
          });
          btn.addEventListener("click", ()=>{
            const newVal = !h.entries[key];
            setDone(h, key, newVal);
            styleCell(btn, newVal, palette, true);
            updateStatsThrottled();
          });
        }else{
          btn.disabled = true;
          btn.classList.add("muted");
        }
        colFrag.appendChild(btn);
      }
      grid.appendChild(colFrag);
    });

    // focus handling
    setupKeyboard(grid);
    scrollToToday(grid);
  }

  function styleCell(el, done, palette, animate=false){
    if(done){
      // intensity could be 1..4 based on "streak window" count in weekâ€”simple heuristic:
      const date = parseDate(el.dataset.date);
      const iso = fmtDate(date);
      const h = selected(); // may be null in edge, but here exists
      const intensity = intensityFor(h, iso);
      el.style.background = palette[intensity];
      el.style.borderColor = "transparent";
      if(animate){
        el.animate([{transform:"scale(0.8)"},{transform:"scale(1)"}], {duration:120, easing:"ease-out"});
      }
      el.setAttribute("aria-pressed","true");
    }else{
      el.style.background = "var(--cell-bg)";
      el.style.borderColor = "var(--cell-bd)";
      el.setAttribute("aria-pressed","false");
    }
  }

  function intensityFor(habit, iso){
    // Count hits in a sliding 7-day window for rough intensity
    const d = parseDate(iso);
    let count=0;
    for(let i=0;i<7;i++){
      const dd = new Date(d); dd.setDate(d.getDate()-i);
      if(habit.entries[fmtDate(dd)]) count++;
    }
    // map 0..7 -> 0..4
    return Math.min(4, Math.max(1, Math.ceil(count/2))); // 0 handled by "not done"
  }

  function setDone(h, iso, v){
    if(v){ h.entries[iso] = true } else { delete h.entries[iso] }
    save();
  }

  function setupKeyboard(grid){
    // set initial focus to today cell if exists
    const idxToday = $$(`.cell[data-date="${todayStr()}"]`, grid)[0];
    if(idxToday) idxToday.tabIndex = 0;

    grid.addEventListener("keydown", (e)=>{
      const focusable = $$(".cell[aria-pressed]", grid);
      const current = document.activeElement.closest(".cell");
      if(!current || !focusable.includes(current)) return;
      const i = focusable.indexOf(current);
      const cols = grid.childNodes.length / 7 | 0; // approximate
      const rows = 7;

      let ni = i;
      if(e.key==="ArrowRight") ni = i + rows;
      else if(e.key==="ArrowLeft") ni = i - rows;
      else if(e.key==="ArrowDown") ni = i + 1;
      else if(e.key==="ArrowUp") ni = i - 1;
      else if(e.key==="Home") ni = i - (i % rows);
      else if(e.key==="End") ni = i + (rows-1 - (i % rows));
      else if(e.key==="Enter" || e.key===" "){
        current.click();
        e.preventDefault();
        return;
      }else return;

      ni = clamp(ni, 0, focusable.length-1);
      focusable[ni].tabIndex = 0;
      current.tabIndex = -1;
      focusable[ni].focus();
      e.preventDefault();
    });
  }

  function scrollToToday(grid){
    const t = $(`.cell[data-date="${todayStr()}"]`, grid);
    if(t){
      const rect = t.getBoundingClientRect();
      grid.scrollLeft = Math.max(0, t.offsetLeft - grid.clientWidth/2 + rect.width);
    }
  }

  // --- Stats ----------------------------------------------------------------
  function calcStats(h){
    const year = state.year;
    const start = fmtDate(new Date(Date.UTC(year,0,1)));
    const end = fmtDate(new Date(Date.UTC(year,11,31)));
    const doneDays = Object.keys(h.entries).filter(d => d>=start && d<=end).sort();
    // streak now
    let streakNow = 0;
    for(let d=new Date(); fmtDate(d)>=start; d.setDate(d.getDate()-1)){
      if(h.entries[fmtDate(d)]) streakNow++; else break;
    }
    // max streak
    let maxStreak = 0, cur = 0, prev=null;
    doneDays.forEach(d=>{
      if(!prev){ cur=1; maxStreak=Math.max(maxStreak,cur); prev=d; return; }
      const pd = parseDate(prev), cd = parseDate(d);
      const diff = Math.round((cd-pd)/86400000);
      if(diff===1){ cur++; } else { cur=1; }
      maxStreak = Math.max(maxStreak, cur);
      prev=d;
    });
    // rate
    const totalDays = (new Date(year,11,31) - new Date(year,0,1)) / 86400000 + 1;
    const rate = (doneDays.length / totalDays) * 100;
    return { streakNow, maxStreak, rate: Math.round(rate*10)/10 };
  }

  const updateStats = ()=>{
    const h = selected();
    if(!h){
      $("#streakNow").textContent = "-";
      $("#streakMax").textContent = "-";
      $("#rate").textContent = "-";
      return;
    }
    const s = calcStats(h);
    $("#streakNow").textContent = `${s.streakNow}æ—¥`;
    $("#streakMax").textContent = `${s.maxStreak}æ—¥`;
    $("#rate").textContent = `${s.rate}%`;
  };
  const updateStatsThrottled = throttle(updateStats, 60);

  function throttle(fn, ms){
    let t=0, queued=false;
    return function(){
      const now = performance.now();
      if(now - t >= ms){ t=now; fn(); }
      else if(!queued){
        queued=true;
        setTimeout(()=>{ queued=false; t=performance.now(); fn(); }, ms - (now - t));
      }
    }
  }

  // --- Theme ----------------------------------------------------------------
  function applyTheme(){
    document.getElementById("app").setAttribute("data-theme", state.theme);
    $("#themeBtn").setAttribute("aria-pressed", state.theme==="light" ? "true" : "false");
  }

  // --- Export / Import ------------------------------------------------------
  function exportJson(){
    const data = JSON.stringify({habits: state.habits}, null, 2);
    const blob = new Blob([data], {type:"application/json"});
    const a = document.createElement("a");
    const now = new Date();
    const iso = now.toISOString().slice(0,10);
    a.href = URL.createObjectURL(blob);
    a.download = `habits-${iso}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function importJson(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const parsed = JSON.parse(reader.result);
        if(!parsed || !Array.isArray(parsed.habits)) throw new Error("ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¸æ­£");
        state.habits = parsed.habits;
        state.selectedId = state.habits[0]?.id ?? null;
        save(); renderHabits(); renderHeatmap(); updateStats();
      }catch(e){
        alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
      }
    };
    reader.readAsText(file, { encoding: "utf-8" });
  }

  // --- Events ---------------------------------------------------------------
  function bindEvents(){
    // add habit
    $("#addForm").addEventListener("submit", (e)=>{
      e.preventDefault();
      const name = $("#name").value.trim();
      if(!name) return;
      const emoji = $("#emoji").value.trim() || "âœ…";
      const hue = $("#hue").value;
      const h = newHabit(name, emoji, hue);
      state.habits.push(h);
      state.selectedId = h.id;
      save();
      $("#name").value = ""; $("#emoji").value = "";
      renderHabits(); renderHeatmap(); updateStats();
    });

    // drag end
    document.addEventListener("mouseup", ()=> state.drag.active=false);
    document.addEventListener("mouseleave", ()=> state.drag.active=false);

    // theme
    $("#themeBtn").addEventListener("click", ()=>{
      state.theme = state.theme === "light" ? "" : "light";
      applyTheme(); save();
    });

    // keyboard shortcut L
    document.addEventListener("keydown", (e)=>{
      if(e.key.toLowerCase()==="l" && !e.target.matches("input, textarea, select")){
        e.preventDefault();
        $("#themeBtn").click();
      }
    });

    // export/import
    $("#exportBtn").addEventListener("click", exportJson);
    $("#importFile").addEventListener("change", (e)=>{
      const file = e.target.files[0];
      if(file) importJson(file);
      e.target.value = "";
    });

    // today
    $("#todayBtn").addEventListener("click", ()=> scrollToToday($("#grid")));

    // clear all
    $("#clearAll").addEventListener("click", ()=>{
      if(confirm("ã™ã¹ã¦ã®ç¿’æ…£ã¨è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
        state.habits = [];
        state.selectedId = null;
        save(); renderHabits(); renderHeatmap(); updateStats();
      }
    });
  }

  // --- Helpers --------------------------------------------------------------
  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  // --- Init -----------------------------------------------------------------
  function init(){
    load();
    applyTheme();
    bindEvents();
    renderHabits();
    if(!state.selectedId && state.habits[0]) state.selectedId = state.habits[0].id;
    renderHeatmap();
    updateStats();
  }
  init();
})();
</script>
</body>
</html>
